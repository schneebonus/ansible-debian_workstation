
- name: Install security tools
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - firejail
    - usbguard
    - usbguard-applet-qt
    - auditd
    - apparmor
    - apparmor-utils
    - apparmor-profiles-extra

- name: "Enable apparmor in grub configuration"
  lineinfile:
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet apparmor=1 security=apparmor"'
    regexp: "^GRUB_CMDLINE_LINUX_DEFAULT=.*"
    state: present
    path: /etc/default/grub
  register: grub_cmdline

- name: "Re-generate grub configuration"
  shell: update-grub
  when: grub_cmdline.changed

- name: enable firejail for all default profiles
  shell: firecfg

- name: allow user null to add usb devices
  lineinfile:
    path: /etc/usbguard/usbguard-daemon.conf
    state: present
    regexp: '^IPCAllowedUsers.*'
    line: 'IPCAllowedUsers=root null'
    owner: root
    group: root
    mode: '0644'

- name: copy aa extra profiles
  shell: 'cp -f /usr/share/doc/apparmor-profiles/extras/*.* /etc/apparmor.d/'

